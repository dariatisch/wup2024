{
  "hash": "527f52c6eb6a40e53bae929da0b9fcc3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"3. Übungsblatt (Ereignisdatenanalyse)\"\nauthor: \"Daria Tisch\"\nformat: \n  html:\n    code-fold: true\n    code-tools: true\n    code-link: true\n    df-print: paged\n    code-line-numbers: true\n  pdf: default\neditor: visual\nnumber-sections: true\n---\n\n\n\n\n\n\n\n\n# Organisation\n\n## Arbeitsverzeichnis festsetzen\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# set working directory\nsetwd(\"C:/Users/ti/Local/seafile/main/teaching/2024_wuppertal/studis/uebungen\")\n```\n:::\n\n\n\n\n\n\n\n\n## Packages installieren und laden\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Packages\npkgs <- c(\n  \"tidyverse\",\n  \"sjPlot\", # nice html tables\n  \"survival\", # survival analysis\n  \"ggsurvfit\" # flexible time-to-event figures\n) \n\n## Install uninstalled packages\nlapply(pkgs[!(pkgs %in% installed.packages())], install.packages)\n\n## Load all packages to library\nlapply(pkgs, library, character.only = TRUE)\n```\n:::\n\n\n\n\n\n\n\n\n## Daten einlesen\n\nWir arbeiten mit einem Datensatz, der Teil des R-Pakets {survival} ist. Bitte lasse Dir alle Datensätze des Pakets anzeigen und speichere den Datensatz lung als *df*.\n\nDatensätze, die im Package survival enthalten sind, anzeigen:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(package = \"survival\")\n```\n:::\n\n\n\n\n\n\n\n\n*lung* Datensatz als *df* speichern:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Lungenkrebsdatensatz als df speichern \ndf = lung\n```\n:::\n\n\n\n\n\n\n\n\nSchaue Dir nun die Beschreibung des Datensatzes an:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n?lung\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nstarte den http Server für die Hilfe fertig\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nDer Datensatz enthält also Informationen zu PatientInnen der North Central Cancer Treatment Group.\n\n# Datenaufbereitung\n\nIn dieser Übung möchten wir untersuchen, ob es Unterschiede zwischen Männern und Frauen in der Überlebenszeit bei Lungenkrebs gibt.\n\nWir brauchen für unsere Analyse daher die folgenden 3 Variablen:\n\n-   dead (0: lebend, 1: tot)\n-   female (0: männlich, 1: weiblich)\n-   time (Tage)\n\nBitte suche diese heraus oder erstelle sie.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- df %>% \n  mutate(\n    dead = recode(status, `1` = 0, `2` = 1),\n    female = recode(sex, `1` = 0, `2` = 1)\n  )\n```\n:::\n\n\n\n\n\n\n\n\n# Datenexploration\n\n## Anzahl Beobachtungen\n\nWie viele Personen sind in dem Datensatz?\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlength(df$dead)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 228\n```\n\n\n:::\n\n```{.r .cell-code}\nnrow(lung)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 228\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n## Anzahl Frauen und Männer\n\nWie viele Frauen und Männer sind jewils in dem Datensatz?\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(df$female)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  0   1 \n138  90 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n## Anzahl Personden, die im Beobachtungszeitraum gestorben sind\n\nWie viele Personen sind im Beobachtungszeitraum gestorben?\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(df$dead)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  0   1 \n 63 165 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n## Kreuztabelle Geschlecht und Überleben\n\nWie viel Prozent der Frauen und wie viel Prozent der Männer sind im Beobachtungszeitraum gestorben?\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>%\n  group_by(female) %>%\n  summarise(\n    total = n(),                           # Gesamtanzahl je Geschlecht\n    deaths = sum(dead == 1),             # Anzahl der gestorbenen Personen\n    percent_deaths = (deaths / total) * 100  # Prozentsatz der Gestorbenen\n  ) %>%\n  arrange(female) \n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"female\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"total\"],\"name\":[2],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"deaths\"],\"name\":[3],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"percent_deaths\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0\",\"2\":\"138\",\"3\":\"112\",\"4\":\"81.15942\"},{\"1\":\"1\",\"2\":\"90\",\"3\":\"53\",\"4\":\"58.88889\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n\n\n\n\n\n\n# Ereignisdatenanalyse\n\n## Zensierung\n\nWie viele rechtszensierte und wie viele linkszentrierte Beobachtungen liegen vor?\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(df$dead)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  0   1 \n 63 165 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n## Erste 10 Fälle\n\nSchauen wir uns die ersten 10 Fälle des Datensatzes an. Was bedeutet das + hinter einer Zahl?\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSurv(df$time, df$dead)[1:10]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1]  306   455  1010+  210   883  1022+  310   361   218   166 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nDas + bedeutet, dass es sich um rechtszensierte Fälle handelt. Diese Personen leben zum Ende des Beobachtungszeintraums noch.\n\nWas ist wohl der Nullpunkt der Zeitvariable *time*?\n\n## Kaplan-Meier-Kurve\n\nErstelle eine Kaplan-Meier-Kurve.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvfit2(Surv(time, dead) ~ 1, data = df) %>% \n  ggsurvfit() +\n  labs(\n    x = \"Tage\",\n    y = \"Überlebenswahrscheinlichkeit\"\n  )\n```\n\n::: {.cell-output-display}\n![](3_uebungsblatt_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n## Kaplan-Meier-Kurve mit KI\n\nNun ergänze die Kurve mit einem Konfidenzintervall.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvfit2(Surv(time, dead) ~ 1, data = df) %>% \n  ggsurvfit() +\n  labs(\n    x = \"Tage\",\n    y = \"Überlebenswahrscheinlichkeit\"\n  )+ \n  add_confidence_interval()\n```\n\n::: {.cell-output-display}\n![](3_uebungsblatt_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n## Kaplan-Meier-Kurve mit Ki und Risikotabelle\n\nUnd nun füge bitte noch eine Risikotabelle hinzu.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvfit2(Surv(time, dead) ~ 1, data = df) %>% \n  ggsurvfit() +\n  labs(\n    x = \"Tage\",\n    y = \"Überlebenswahrscheinlichkeit\"\n  )+ \n  add_confidence_interval() +\n  add_risktable()\n```\n\n::: {.cell-output-display}\n![](3_uebungsblatt_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nWie viele Personen leben nach 500 Tagen noch?\n\n## Schätzung der Überlebensrate nach einem Jahr\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(survfit(Surv(time, dead) ~ 1, data = df), times = 365)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall: survfit(formula = Surv(time, dead) ~ 1, data = df)\n\n time n.risk n.event survival std.err lower 95% CI upper 95% CI\n  365     65     121    0.409  0.0358        0.345        0.486\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nWir stellen fest, dass die 1-Jahres-Überlebenswahrscheinlichkeit in dieser Studie 41% beträgt.\n\n# Überlebenszeit im Median\n\nWie viele Tage übleben die PatientInnen im Median?\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvfit(Surv(time, dead) ~ 1, data = df)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall: survfit(formula = Surv(time, dead) ~ 1, data = df)\n\n       n events median 0.95LCL 0.95UCL\n[1,] 228    165    310     285     363\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n# Kaplan-Meier-Kurve nach Geschlecht\n\nNun möchten wir die Geschlechterunterschiede in der Überlebenswahrscheinlichkeit über die Zeit graphisch untersuchen.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvfit2(Surv(time, dead) ~ female, data = df) %>% \n  ggsurvfit() +\n  labs(\n    x = \"Tage\",\n    y = \"Überlebenswahrscheinlichkeit\",\n    color = \"Geschlecht\"\n  )+ \n  add_confidence_interval() +\n  add_risktable() + \n scale_color_manual(values = c('darkblue', 'darkred'),  labels = c(\"Männer\", \"Frauen\") ) +\n  scale_fill_manual(values = c('darkblue', 'darkred'),  labels = c(\"Männer\", \"Frauen\") ) +\n  theme_minimal() + guides(fill = \"none\")\n```\n\n::: {.cell-output-display}\n![](3_uebungsblatt_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n# Cox Proportional Hazards Model\n\nNun schätzen wir ein Cox Proportional Hazards Model. Gibt es signifikante Geschlechterunterschiede? Ist die Proportionalitätsannahme erfüllt?\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel1 = coxph(Surv(time, dead) ~ female, data = df)\nsummary(model1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(time, dead) ~ female, data = df)\n\n  n= 228, number of events= 165 \n\n          coef exp(coef) se(coef)      z Pr(>|z|)   \nfemale -0.5310    0.5880   0.1672 -3.176  0.00149 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n       exp(coef) exp(-coef) lower .95 upper .95\nfemale     0.588      1.701    0.4237     0.816\n\nConcordance= 0.579  (se = 0.021 )\nLikelihood ratio test= 10.63  on 1 df,   p=0.001\nWald test            = 10.09  on 1 df,   p=0.001\nScore (logrank) test = 10.33  on 1 df,   p=0.001\n```\n\n\n:::\n\n```{.r .cell-code}\ncox.zph(model1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       chisq df     p\nfemale  2.86  1 0.091\nGLOBAL  2.86  1 0.091\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nErstelle eine Tabelle zur besseren Übersicht\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntab_model(model1,\n          show.ci = FALSE, p.style = \"stars\",\n          string.se = \"se\", string.est = \"HR\",\n          string.pred = \" \")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table style=\"border-collapse:collapse; border:none;\">\n<tr>\n<th style=\"border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm;  text-align:left; \">&nbsp;</th>\n<th colspan=\"1\" style=\"border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm; \">Surv(time, dead)</th>\n</tr>\n<tr>\n<td style=\" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  text-align:left; \"> </td>\n<td style=\" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  \">HR</td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; \">female</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.59 <sup>**</sup></td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm; border-top:1px solid;\">Observations</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left; border-top:1px solid;\" colspan=\"1\">228</td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;\">R<sup>2</sup> Nagelkerke</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;\" colspan=\"1\">0.046</td>\n</tr>\n<tr>\n<td colspan=\"2\" style=\"font-style:italic; border-top:double black; text-align:right;\">* p&lt;0.05&nbsp;&nbsp;&nbsp;** p&lt;0.01&nbsp;&nbsp;&nbsp;*** p&lt;0.001</td>\n</tr>\n\n</table>\n\n`````\n:::\n:::\n\n\n\n\n\n\n\n\n## Interpretiere den Koeffizienten von *female*:\n\nBei einem Cox-Regressionsmodell interessieren wir uns meist für die Hazard Ratio (HR). Die HR stellt das Verhältnis der Risiken zwischen zwei Gruppen zu einem bestimmten Zeitpunkt dar. Die HR wird als die momentane Rate des Auftretens des interessierenden Ereignisses bei denjenigen interpretiert, die noch ein Risiko für dieses Ereignis haben. Die HR ist exp(β).\n\n-   HR \\< 1: verringertes Sterberisiko\n-   HR \\> 1: erhöhtes Sterberisiko\n\nHR = 0,59: Zu einem bestimmten Zeitpunkt sterben 0,59 mal so viele Frauen wie Männer. Frauen haben in dieser Stichprobe ein deutlich geringeres Sterberisiko als Männer.\n\n# Render\n\nWandle dieses Dokument in ein PDF und ein HTML Dokument um.\n\n# Weiterführende Literatur\n\n-   [R for Data Science](https://r4ds.had.co.nz/)\n-   [https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html](https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html)\n\n\n",
    "supporting": [
      "3_uebungsblatt_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}